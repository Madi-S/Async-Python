# MongoDB Connector

## Введение

Это NoSQL база данны, не являющиеся табличной базой и хранит данные иначе, чем реляционные базы данных по типу PostgreSQL.

NoSQL базы данных бывают разные:

-   Документированные
-   Key-Value
-   Колоночная
-   Графовая

Создавались они для обработки больших объемов данных и более легко масштабирования под высокие нагрузки.

Документированные БД хранят данные в документах, подобных объектам JSON. Каждый документ содержит пары полей и значений. Значения могут быть различных типов, включая такие типы, как строки, числа, bool, массивы или объекты.

Базы данных "ключ-значение" - более простой тип БД, где каждый элемент содержит ключи и значения.

Колоночные БД похожи на реляционные, за тем исключением, что данные хранятся не по строкам, а в колонках. Такие базы применяются для построения для построения аналитики в реальном времени. На основе такое БД построена Яндекс.Метрика.

Графовые базы данных хранят данные в узлах и ребрах в виде графов Узлы обычно хранят информацию о людях, местах и вещах, а ребра хранят информацию о взаимосвязях между узлами.

Примеры:

-   Документированные: couchbase, mongodb
-   Key-Value: redis, memcached
-   Колоночная: clickhouse
-   Графовая: neo4j

### Отличие реляционное схемы хранения от NoSQL

Несмотря на то, что между системами управления реляционными базами данных (СУБД) и базами данных NoSQL существует множество различий, одним из ключевых различий является способ хранения данных в БД.

Чтобы разобраться в отличиях между реляционными БД и NoSQL-БД, рассмотрим пример хранения информации о пользователе и его увлечениях. Нам нужно сохранить имя, фамилию номер мобильного телефона, город и увлечения пользователя.

В реляционной БД мы создадим две таблицы - users и hobbies:

![relational_db_tables](/static/relational_db.png)

Чтобы получить информацию о пользователе и его хобби одним запросом, нужно соединить 2 таблицы и написать примерно такой запрос:

```sql
SELECT u.*, h.hobby FROM Users AS u LEFT JOIN Hobbies AS h ON (h.user_id = u.user_id) WHERE u.id = 1
```

В случае с такой документированной БД, как MongoDB, можно сложить данные в один документ. Тогда схема данных будет выглядить следующим образом:

```json
{
    "_id": "uuid",
    "first_name": "Post",
    "last_name": "Malone",
    "cell": "8341923438",
    "city": "Manchester",
    "hobbies": ["singing", "video games", "cooking"]
}
```

Вся информация хранится внутри одного "документа", а данные можно получить за один запрос без соединений таблиц.

### Преимущества No-SQL подхода

<b>Гибкие модели данныех.</b> Базы данных No-SQL обычно имеют гибкие схемы, то есть записи в одной таблице (в терминах реляционных БД) могут иметь разный формат. Гибкая схема позволяет легко вносить изменения в базу данных по мере изменения требований.

Но в таком подходе есть существенный минус: нет фиксированной структуры, ,нет схемы данных, а значит, нужно быть готовым к сюрпризам, например, отсутствию полей, недопустимым типам данных и т.д.

Между реляционными и No-SQL базами данных можно провести аналогию с ЯП с динамической и статической типизацией. К примеру, Python и Golang/C++. В Python переменной можно присвоить любой тип, и это дает свои преимущества: код писать быстрее, его проще тестировать и т.д. Но в это же время мы не всегда знаем, какой тип принимает или возвращает функция. Иногда сложно догадаться, какая вообще будет вызвана функция, так как она была добавлена "черноей магией" питона.

<b>Горизонтальное масштабирование.</b> Для больнинства БД SQL требует вертикальное масштабирование - переход на более крупный и более дорогой сервер, когда нагрузка превышает возможности текущего. И наоборот больниство баз данных NoSQL позволяют масштабироваться горизонтально: вы можете добавлять более дешевые стандартные серверы, когда нужно.

<b>Быстрые запросы.</b> Запросы в базах данных NoSQL могут быть быстрее, чем в базах данных SQL. Почему? Данные в SQL-БД обычно нормализованы, поэтому запросы для одного объекта или сущности требуют объединения данных из нескольких таблиц. По мере роста ваших таблиц соединения могут стать дорогостоящими. Однако данные в базах данных NoSQL обычно хранятся так, чтобы оптимизировать их для запросов. Эмпирическое правило при использовании MongoDB - данные, которые доступны вместе, должны храниться вместе. Запросы обычно не требуют объединений, поэтому могут выполняться быстрее.

В этой главе мы не будем рассматривать все возможности MongoDB, это тема для отедльного разговора.

## Connectors

Рассмотрим две библиотеки (коннекторы или драйверы, кто как называет) для MongoDB:

-   [Motor](https://motor.readthedocs.io/en/stable/index.html): официальная асинхронная библиотека

-   [Aiomongo](https://github.com/sakal/aiomongo): неофициальная библиотека, которая не поддерживается без звездочек на GitHub

Спрведливый вопрос: зачем тогда существует aiomongo?

Если посмотреть в исходники библиотеки motor, можно найти использование функции `run_in_executor`. Как вы помните, `run_in_executor` помогает запускать синхронные IO-Bound операции асинхронно. Авторы библиотеки motor решили не переписывать библиотеку специально под asyncio, а использовали такой подход. В библиотеке вызываются методы из синхронного коннектора для MongoDB - pymongo.

Библиотеку aiomonngo написали без использования функции `run_in_executor` и поддержали нативные механизмы asyncio. Она получилась быстрее, можно посмотреть benchmark'и. Но по разным причинам она не поддерживается и не развивается. На текущий момент не рекомендуется использовать её в продакшне.
