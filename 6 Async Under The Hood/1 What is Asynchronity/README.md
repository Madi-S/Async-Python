# Что такое асинхронность

## Кооперативная многозадачность

Мы уже говорили про потоки и процессы - средства, позволяющие одновременно с течением программы выполнить какую-то дополнительную работу.

Минус процессов и тредов в том, что это безумно тяжелые объекты. Поэтому нельзя создавать много процессов или тредов одновременно - банально не хватит памяти.

Сейчас мы разберемся, как происходит создание нового процесса на уровне операционной системы.

### Старт процессов

В Linux и MacOS старт процесса осуществляется с помощью двух системных вызовов. В Windows свои интересные штуки, но все это близко и похоже по реализации.

Всегда есть родительский процесс, запускающий другой процесс. Если мы запускаем Python, родительским процессом всегда является bash, то есть, наша командная строка.

При старте системы существует один единственныей процесс, который имеет id 1. Он и является родительским процессом для всех остальных.

### Fork и Exec

Задача fork в том, чтобы отоединиться от текущего процесса. Отсоединение означает, что вся память процесса копируется в новую сущность, которая затем может продолжить существовать.

Вызов в exec заменяет текущий контекст выполнения новой сущности другой программой.

Например, в терминале мы вызывали функцию find:

1. Произошел вызов fork - вся память процесса терминала скопировалась в новый созданный процесс.
2. Произошел вызов exec - текущий контекст выполнения (то есть терминал) сменился на контекст выполнения программы find.
3. find теперь выполняется в другом дочернем для терминала процессе.

Создание нового процесса - это очень долгое и очень дорогое по памяти явление.

### Потоки

Потоки как будто решают проблему с памятью и временем создания. Их дешевле создавать, и они находятся в рамках одного процесса. Но это не лучшее решение проблемы: запуск одного потока означает копирование состояния процесса, потому что ему все равно нужно создать какие-то структуры.

Это гораздо быстрее но нельзя создать, например, 1000 полноценно-рабощих потоков, если процессор не состоит из 1000 ядер.

Для работы потока в полную силу ему нужно отдельное ядро процессора. Чаще всего в одном процессе запускают не так много потоков. Например, если работает какой-то веб-сервер, там запускает число потоков, равное числу ядер - либо чуть больше.

### Асинхронный подход

Допустим мы хотим скачать весь сайт. Например, всю Википедию.

Мы получили список ссылок, который состоит из 1,000,000 документов. Если мы хотим сделать это как можно быстрее, то попробуем создать 1,000,000 потоков и быстро все скачать.

Но так не получится: во-первых, мы упремся в память, потому что потоки много весят в оперативной памяти; во-вторых, даже если бы все они влезли, процессор не смогу бы обеспечить нормальный квант времени каждому из потоков. Кому-то придется ждать и достаточно долго. Скорее всего на 4-ядерной системе будут работать 4-8 потоков, и все остальные будут просто по очереди ждать и завершаться.

Тут нам на помощь приходит асинхронный подход: идея в том, чтобы не ждать какой-то операции, а доверить это ожидание кому-то другому.

Теперь давайте разберемся, как вообще работать с сетью без библиотек requests и aiohttp, чтобы подойти к идее асинхронного программирования.
